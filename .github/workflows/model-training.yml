name: Model Training Pipeline

on:
  schedule:
    # Run weekly on Sunday at 1 AM UTC
    - cron: '0 1 * * 0'
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: '3.10'

jobs:
  train-models:
    name: Train ML Models
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download training data
      run: |
        # Download from S3 or data warehouse
        echo "Downloading training data..."
        # aws s3 cp s3://your-bucket/training-data ./data/
    
    - name: Train churn model
      run: |
        python -m backend.orchestration.training_orchestrator \
          --model-type churn \
          --config backend/models/churn/config.yaml
    
    - name: Train CLV model
      run: |
        python -m backend.orchestration.training_orchestrator \
          --model-type clv \
          --config backend/models/clv/config.yaml
    
    - name: Train segmentation model
      run: |
        python -m backend.orchestration.training_orchestrator \
          --model-type segmentation \
          --config backend/models/segmentation/config.yaml
    
    - name: Evaluate models
      run: |
        python -m backend.evaluation.evaluate_all_models
    
    - name: Upload model artifacts
      uses: actions/upload-artifact@v3
      with:
        name: trained-models
        path: |
          backend/models/*/champion.pkl
          backend/models/*/metrics.json
    
    - name: Notify training completion
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        text: 'Model training ${{ job.status }}'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
